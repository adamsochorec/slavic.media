name: Test and Deploy

# This workflow gets triggered on every push to the specific branch
on:
  push:
    branches: [main]

jobs:
  test:
    name: Backend tests
    runs-on: ubuntu-latest # The type of machine to run the job on

    # This strategy runs the job on multiple versions of Node.js
    strategy:
      matrix:
        node-version: [20.x]

    # The steps that the job will run
    steps:
      # This step checks out a copy of your repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # This step sets up Node.js on the runner
      - name: Use Node.JS ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # This step installs dependencies, builds the application, and runs tests
      - name: NPM install, build and test
        run: |
          cd backend
          npm install
          npm test
        env:
          # Environment variables for the test script
          DBHOST: ${{ secrets.DBHOST }}
          TOKEN_SECRET: ${{ secrets.TOKEN_SECRET }}
          JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}

  # Deploy both frontend and backend only if backend tests pass
  deploy:
    name: Deploy to Production
    needs: [test] # This job depends on the backend tests passing
    runs-on: ubuntu-latest # The type of machine to run the job on

    # The steps that the job will run
    steps:
      # This step deploys both frontend and backend to production
      - name: Deploy frontend and backend to production
        run: |
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
